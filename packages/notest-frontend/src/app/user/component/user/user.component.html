<h1 class="m-4">User Control Panel</h1>
<div *ngIf="user" class="p-4 flex">
  <div class="w-1/2">
    <div class="flex gap-2 items-center">
      <nt-icon class="h-6 w-6 text-nt-500 " name="user"></nt-icon>
      <h3>Profile</h3>
    </div>
    <div class="flex gap-4 mt-4">
      <input class="mt-0" label="name" type="text" name="name" [(ngModel)]="user.name"/>
      <nt-profile-image [userid]="user.nt_userid" [fullname]="user.name + ' ' + user.surname"></nt-profile-image>
    </div>
    <input label="surname" type="text" name="surname" [(ngModel)]="user.surname"/>
    <input label="telephone" type="text" name="telephone" [(ngModel)]="user.phone"/>
    <input label="E-mail" type="text" name="email" [(ngModel)]="user.email"/>
    <div class="form-success" *ngIf="userInfoUpdated">
      Information saved Correctly
    </div>
    <div *ngIf="rolesService.isAdmin">
      <nt-autocomplete label=Roles [items]="NTRoleMap" [property]="'name'"
                       (itemSelected)="toggleRole($event.value)"></nt-autocomplete>
      <div class="flex">
        <nt-badge class="sm" *ngFor="let role of user.roles">{{NTRoleLabelsMap[role]}}</nt-badge>
      </div>
    </div>
    <div class="flex mt-8 items-center gap-2">
      <input class="mt-0" pattern="^(https?:\/\/)?([\da-z.-]+)\.([a-z.]{2,6})([\/\w.-]*)*\/?$" #domainInput label="Add new Domain"/>
      <button *ngIf="domainInput.value"
              class="h-fit animation-appear"
              (click)="toggle(domainInput.value, user.domains!)">
        {{user.domains!.includes(domainInput.value) ? 'Remove' : 'Add'}}
      </button>
    </div>
    <nt-badge class="sm" *ngFor="let domain of user.domains">{{domain}}</nt-badge>

  </div>
  <div class="w-1/2">
    <div class="flex gap-2 items-center">
      <nt-icon class="h-6 w-6 text-nt-500 " name="advanced"></nt-icon>
      <h3>Advanced</h3>
    </div>
    <input *ngIf="user.nt_userid" label="current password" type="password" name="password"
           [(ngModel)]="currentPassword"/>
    <div class="form-error" *ngIf="!currentPasswordMatch">Incorrect Password</div>
    <input label="new password" type="password" name="password" [(ngModel)]="newPassword"/>
    <input label="repeat new password" type="password" name="newPassword" [(ngModel)]="newPasswordRepeated"/>
    <div class="form-success" *ngIf="passwordUpdated">Password Successfully Updated</div>

    <ng-container *ngIf="user.nt_userid == tokenService.tokenData().id">
      <div class="flex gap-2 items-center mt-4">
        <nt-icon class="h-6 w-6 text-nt-500 " name="key"></nt-icon>
        <h3>API Token</h3>
      </div>
      <div class="flex flex-row gap-2 items-center">
      <textarea label="your token" disabled class="mt-4 mr-2 min-h-[192px] min-w-[500px] scrollbar-sm" type="text"
                [(ngModel)]="user.api_token"></textarea>
        <nt-icon *ngIf="!user.api_token" title="Generate Api Token" class="h-8 w-8 text-nt-500 cursor-pointer "
                 name="plus"
                 (click)="generateApiToken()"></nt-icon>
        <div class="flex flex-col gap-2">
          <nt-icon *ngIf="user.api_token" title="Copy Api Token" class="h-7 w-7 text-nt-500 cursor-pointer " name="copy"
                   (click)="copyToClipboard(user.api_token)"></nt-icon>
          <nt-icon *ngIf="user.api_token" title="Delete Api Token" class="h-8 w-8 text-nt-500 cursor-pointer "
                   name="delete"
                   (click)="deleteToken()"></nt-icon>
        </div>
      </div>
    </ng-container>
  </div>
</div>

<div *ngIf="user" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 flex gap-4">
  <div *ngIf="showSaveButton && !success && !error" class="save-popup">
    <ng-container *ngIf="!saving">
      <div *ngIf="user.nt_userid">There are changes not saved</div>
      <div *ngIf="!user.nt_userid">Create User</div>
      <button (click)="saveUser()">Save changes</button>
    </ng-container>
    <ng-container *ngIf="saving">
      <div>Saving...</div>
      <div *ngIf="saving " class="bo-loading"></div>
    </ng-container>
  </div>

  <div *ngIf="error" class="save-popup">
    <div class="text-red-500">{{errorMessage}}</div>
  </div>

  <div *ngIf="success" class="save-popup">
    <div class="flex gap-3 items-center">
      Saved
      <nt-icon class="text-green-500" name="success"></nt-icon>
    </div>
  </div>

  <div *ngIf="showChangePassword && !passwordSuccess && !passwordError" class="save-popup">
    <ng-container *ngIf="changingPassword">
      <div>Changing password...</div>
      <div class="bo-loading"></div>
    </ng-container>
    <button *ngIf="!changingPassword" (click)="changePassword()">Change password</button>
  </div>

  <div *ngIf="passwordError" class="save-popup">
    <div class="text-red-500">{{passwordErrorMessage}}</div>
  </div>

  <div *ngIf="passwordSuccess" class="save-popup">
    <div class="flex gap-3 items-center">
      Saved
      <nt-icon class="text-green-500" name="success"></nt-icon>
    </div>
  </div>
</div>
