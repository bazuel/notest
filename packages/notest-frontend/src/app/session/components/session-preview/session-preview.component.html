<div *ngIf="session && !fullLoading" class="h-full w-full flex bg-nt-50">
  <div class="relative flex-1 h-full">
    <div class="flex gap-4 p-4 items-center">
      <input class="input-on-focus font-semibold text-gray-500" [(ngModel)]="session.info.title"
             (ngModelChange)="debouncedSaveSession()"/>
      <button class="h-fit" title="Go to Developer mode" (click)="goToDebugger(session.reference)">Developer Mode
      </button>
    </div>
    <div
      class="group px-6 py-1.5 rounded-full bg-white mx-6 text-gray-500 border border-gray-300 flex items-center">
      {{session.url}}
      <nt-icon class="opacity-0 group-hover:opacity-100 ml-auto  cursor-pointer" name="copy"
               (click)="copyToClipboard(session.url)"></nt-icon>
    </div>
    <div class="relative m-5 rounded-md shadow-md overflow-hidden min-h-[600px] bg-white">

      <ng-container *ngIf="!useOriginalScreenshot">
        <div *ngIf="!videoLoaded"
             class="w-full h-[600px] bg-white bo-loading flex items-center justify-center scale-[300%]"></div>
        <nt-video
          #video
          *ngIf="videoReference"
          [reference]="videoReference"
          (loadedChange)="videoLoaded = $event"></nt-video>
        <nt-screenshot
          class="absolute smooth-open top-0"
          *ngIf="screenshotOnHover"
          [reference]="screenshotOnHover.reference"
          [name]="screenshotOnHover.name"></nt-screenshot>
      </ng-container>
      <nt-screenshot
        class="absolute smooth-open top-0"
        *ngIf="useOriginalScreenshot"
        [reference]="session.reference"
      ></nt-screenshot>
    </div>
  </div>
  <div class="w-1/3 h-full p-3">
    <div
      class="p-3 bg-white flex flex-col rounded-md overflow-hidden shadow-md transition-all cursor-pointer duration-400 h-full">
      <div class="flex justify-items items-center gap-3">
        <div class="text-2xl text-bop mr-4">Run history</div>
        <ng-container *ngIf="!loading">
          <div class="bo-button-icon h-10 px-3 gap-2" title="Rerun session" (click)="rerunSession()">
            <nt-icon name="rerun"></nt-icon>
            <nt-icon
              *ngIf="backendType == 'mock'"
              name="frontend_isolated"
              class="w-5 h-5 text-bop"
              title="Frontend isolated"></nt-icon>
            <nt-icon
              *ngIf="loginSessionSelected"
              name="user"
              class="w-5 h-5 text-bop"
              title="Logged Session"></nt-icon>
          </div>
          <div
            class="bo-button-icon w-10 h-10"
            title="Session settings"
            (click)="showSessionSettings = !showSessionSettings">
            <nt-icon name="settings"></nt-icon>
          </div>
        </ng-container>
        <ng-container *ngIf="loading">
          <div class="bo-button-icon pointer-events-none w-10 h-10 bo-loading p-0"></div>
          <div class="text-nt-300 ml-4 text-bold text-lg">Your session is running...</div>
        </ng-container>
      </div>
      <div class="flex-1 overflow-auto scrollbar-sm">
        <nt-screenshot-list-placeholder *ngIf="!sessionRunHistory || loading"></nt-screenshot-list-placeholder>
        <ng-container *ngFor="let run of sessionRunHistory">
          <div
            *ngIf="run.session"
            class="flex flex-col mt-5"
            (mouseenter)="setSessionHover(run.session)"
            (mouseleave)="setSessionHover(undefined)">
            <div class="flex items-center gap-3">
              <label class="my-5">{{ run.session.created | date : 'dd-MM-YYYY, HH:mm' }}</label>
              <div class="relative flex items-center">
                <nt-assertion-summary-item
                  [assertionList]="run.assertions"
                  type="all"
                  (mouseenter)="run.showInfo = true"
                  (mouseleave)="run.showInfo = false"
                  class="w-5 h-5"
                  (click)="runSelected = run; showAssertionPopup = true"></nt-assertion-summary-item>
                <div *ngIf="run.showInfo" class="nt-session-info-popup p-2">
                  <div class="text-gray-400 w-56">Test Results</div>
                  <nt-assertion-summary-item
                    [assertionList]="run.assertions"
                    type="runSuccessfullyFinished"
                    title="Session Run"></nt-assertion-summary-item>
                  <nt-assertion-summary-item
                    [assertionList]="run.assertions"
                    type="missedEvents"
                    title="Same HTTP Requests"></nt-assertion-summary-item>
                  <nt-assertion-summary-item
                    [assertionList]="run.assertions"
                    type="visual"
                    title="Visual Comparison"></nt-assertion-summary-item>
                  <nt-assertion-summary-item
                    [assertionList]="run.assertions"
                    type="http"
                    name="status"
                    title="HTTP Responses Status"></nt-assertion-summary-item>
                  <nt-assertion-summary-item
                    [assertionList]="run.assertions"
                    type="http"
                    name="bodyRequest"
                    title="HTTP Body Requests"></nt-assertion-summary-item>
                  <nt-assertion-summary-item
                    [assertionList]="run.assertions"
                    type="http"
                    name="contentType"
                    title="HTTP Body type"></nt-assertion-summary-item>
                </div>
              </div>

              <nt-icon
                *ngIf="run.session.info?.backend_type == 'mock'"
                name="frontend_isolated"
                class="w-5 h-5 text-bop"
                title="Frontend isolated"></nt-icon>

              <nt-icon
                *ngIf="run.session.info?.session_logged"
                name="user"
                class="w-5 h-5 text-bop"
                title="Logged Session"></nt-icon>

              <div
                *ngIf="run.session === sessionOnHover"
                class="bo-button-icon w-8 h-8"
                (click)="showVideo(run.session.reference)">
                <nt-icon name="play"></nt-icon>
              </div>
              <div
                *ngIf="run.session === sessionOnHover"
                class="bo-button-icon w-8 h-8"
                (click)="goToDebugger(run.session.reference)">
                <nt-icon name="window"></nt-icon>
              </div>
            </div>
            <div class="flex gap-2 overflow-auto scrollbar-sm">
              <div *ngFor="let image of run.screenshot">
                <nt-screenshot
                  class="transition-all duration-50 w-64 h-28 rounded-md shadow-lg overflow-hidden border-nt-400 m-2 cursor-pointer"
                  [class.border-2]="screenshotOnHover === image"
                  (click)="goToVideo(run.session.reference, image.start!, run.video.start!)"
                  (mouseover)="showImage(image)"
                  (mouseout)="hideImage()"
                  [reference]="image.reference"
                  [name]="image.name"
                  [lazyload]="true"></nt-screenshot>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<nt-session-preview-placeholder *ngIf="fullLoading"></nt-session-preview-placeholder>

<nt-popup *ngIf="showAssertionPopup && runSelected" (close)="showAssertionPopup = false">
  <div class="p-5 w-[1000px] h-fit flex flex-col gap-y-5">
    <h4 class="text-xl">Test Results</h4>
    <nt-assertion-preview
      title="Test Successfully Executed"
      type="runSuccessfullyFinished"
      [assertionList]="runSelected.assertions"></nt-assertion-preview>
    <nt-assertion-preview
      title="Same HTTP Requests"
      type="missedEvents"
      [assertionList]="runSelected.assertions"></nt-assertion-preview>
    <nt-assertion-preview
      title="Visual"
      type="visual"
      [assertionList]="runSelected.assertions"></nt-assertion-preview>
    <nt-assertion-preview
      title="HTTP Response Status"
      type="http"
      name="status"
      [assertionList]="runSelected.assertions"></nt-assertion-preview>
    <nt-assertion-preview
      title="HTTP Body Type"
      type="http"
      name="contentType"
      [assertionList]="runSelected.assertions"></nt-assertion-preview>
    <nt-assertion-preview
      title="HTTP Body Requests"
      type="http"
      name="bodyRequest"
      [assertionList]="runSelected.assertions"></nt-assertion-preview>
  </div>
</nt-popup>

<nt-popup *ngIf="showSessionSettings" (close)="showSessionSettings = false">
  <div class="p-5 w-fit h-fit">
    <h4 class="text-xl">Session Settings</h4>
    <label class="mt-4">Set this session as User Login Session</label>
    <div class="w-fit mt-2">
      <nt-switch
        [switched]="session.info.isLogin"
        (switchedChange)="setIsLoginSessionState($event)"></nt-switch>
    </div>
    <h4 class="text-xl mt-5">Rerun Settings</h4>
    <div class="flex items-end gap-3 mb-2">
      <label class="mt-4">Apply User Login Session</label>
      <nt-icon
        name="user"
        class="w-5 h-5"
        title="Logged Session"
        [class.text-bop]="loginSessionSelected"
        [class.text-gray-300]="!loginSessionSelected"></nt-icon>
    </div>
    <nt-autocomplete
      *ngIf="!loginSessionSelected"
      [items]="loginSessions"
      [property]="'title'"
      (itemSelected)="setLoginReference($event); setIsLoginSessionState(false)"
      placeholder="Select Login Session"></nt-autocomplete>
    <div class="w-fit h-10 flex items-center" *ngIf="loginSessionSelected">
      <nt-badge (click)="setLoginReference(undefined)">
        {{ loginSessionSelected.title }}
      </nt-badge>
    </div>

    <div class="flex items-end gap-3">
      <label class="mt-4">Test Frontend in isolated mode</label>
      <nt-icon
        name="frontend_isolated"
        class="w-5 h-5"
        [class.text-bop]="backendType == 'mock'"
        [class.text-gray-300]="backendType == 'full'"
        title="Frontend isolated"></nt-icon>
    </div>
    <nt-switch
      class="mt-2"
      [switched]="backendType == 'mock'"
      (switchedChange)="toggleBackendType()"></nt-switch>

    <label class="mt-4">Set Custom Domain Settings</label>
    <div class="flex flex-row items-center gap-2 mt-2">
      <input [(ngModel)]="sessionDomain.domain" [placeholder]="'domain'"/>
      :
      <input class="w-14" [(ngModel)]="sessionDomain.port" [placeholder]="'port'"/>
      <nt-switch
        [switched]="sessionDomain.ssl"
        (switchedChange)="sessionDomain.ssl = !sessionDomain.ssl">
        SSL
      </nt-switch>
    </div>
  </div>
</nt-popup>
