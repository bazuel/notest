<div *ngIf='session && !fullLoading' class='h-full w-full p-5 flex'>
  <div class='relative w-2/3 h-2/3'>
    <div class='flex flex-row items-center'>
      <h1 class='font-bold'>{{session.info.title}}</h1>
      <button class='ml-10 h-1/3' title='Go to developer mode' (click)='goToDebugger()'>Developer Mode</button>
    </div>
    <nt-video #video *ngIf='videoReference' class='absolute w-10/12 h-[85%]'
              [reference]=videoReference></nt-video>
    <nt-screenshot class='absolute mt-5 smooth-open w-11/12 h-[85%]' *ngIf='screenshotOnHover'
                   [reference]='screenshotOnHover.reference'
                   [name]=screenshotOnHover.name></nt-screenshot>
  </div>
  <div class='w-1/3 h-4/5 px-8'>
    <div class='flex justify-items items-center gap-3'>
      <label class='text-2xl my-4 mr-4'>Run history</label>
      <ng-container *ngIf='!loading'>
        <div class='bo-button-icon h-10 px-3 gap-2'
             title='Rerun session' (click)='rerunSession()'>
          <nt-icon name='rerun'></nt-icon>
          <nt-icon *ngIf="backendType == 'mock'" name='frontend_isolated'
                   class='w-5 h-5 text-bop'
                   title='Frontend isolated'></nt-icon>
          <nt-icon *ngIf='loginSessionSelected' name='user' class='w-5 h-5 text-bop'
                   title='Logged Session'></nt-icon>
        </div>
        <div class='bo-button-icon w-10 h-10' title='Session settings'
             (click)='showSessionSettings = !showSessionSettings'>
          <nt-icon name='settings'></nt-icon>
        </div>
      </ng-container>
      <ng-container *ngIf='loading'>
        <div class='bo-button-icon pointer-events-none w-10 h-10 bo-loading p-0'></div>
        <div class='text-nt-300 ml-4 text-bold text-lg'>Your session is running... ðŸ˜‰</div>
      </ng-container>
    </div>
    <div class='h-full overflow-auto scrollbar-sm'>
      <nt-screenshot-list-placeholder *ngIf='loading'></nt-screenshot-list-placeholder>
      <div *ngFor='let run of sessionRunHistory' class='flex flex-col mt-5'
           (mouseenter)='setSessionHover(run.session)'
           (mouseleave)='setSessionHover(undefined)'>
        <div class='flex items-center gap-3'>
          <label class='my-5'>{{run.session.created | date:"dd-MM-YYYY, HH:mm"}}</label>
          <nt-icon *ngIf='run.session.info?.internal_error' name='error'
                   class='w-5 h-5 text-red-500'></nt-icon>

          <div class='relative flex items-center cursor-pointer'>
            <nt-icon *ngIf='!run.session.info?.internal_error'
                     name="{{(run.assertion | assertionResults) ? 'success': 'warning'}}"
                     (click)="runSelected = run;showAssertionPopup = true"
                     (mouseenter)="run.showInfo = true"
                     (mouseleave)="run.showInfo = false"
                     class="w-5 h-5"
                     title="Click for more informations"
                     [class.text-orange-500]='!(run.assertion | assertionResults)'
                     [class.text-green-500]='run.assertion | assertionResults'>
            </nt-icon>
            <div *ngIf='run.showInfo' class='nt-session-info-popup'>
              <div class='text-gray-400 w-56 p-2'>Test Results</div>
              <div class="flex flex-row justify-between p-2 items-center">
                <div class='flex flex-row text-sm text-gray-400 w-fit'>Test executed:
                </div>
                <nt-icon class="{{!run.assertion.info?.test_execution_failed ? 'text-green-500' : 'text-orange-500'}}"
                         name="{{!run.assertion.info?.test_execution_failed ? 'success' : 'warning'}}"></nt-icon>
              </div>
              <div class="flex flex-row justify-between p-2 items-center">
                <div class='flex flex-row text-sm text-gray-400 w-fit'>Fetch Response test:
                </div>
                <nt-icon class="{{run.assertion.assertions.fetch_response_pass ? 'text-green-500' : 'text-red-500'}}"
                         name="{{run.assertion.assertions.fetch_response_pass ? 'success' : 'cross'}}"></nt-icon>
              </div>
              <div class="flex flex-row justify-between p-2 items-center">
                <div class='flex flex-row text-sm text-gray-400 w-fit'>Fetch Body Type test:</div>
                <nt-icon class="{{run.assertion.assertions.fetch_body_type_pass ? 'text-green-500' : 'text-red-500'}}"
                         name="{{run.assertion.assertions.fetch_body_type_pass ? 'success' : 'cross'}}"></nt-icon>
              </div>
              <div class="flex flex-row justify-between p-2 items-center">
                <div class='flex flex-row text-sm text-gray-400 w-fit'>Fetch Body test:</div>
                <nt-icon
                  class="{{run.assertion.assertions.response_body_match_pass ? 'text-green-500' : 'text-red-500'}}"
                  name="{{run.assertion.assertions.response_body_match_pass ? 'success' : 'cross'}}"></nt-icon>
              </div>
              <div class="flex flex-row justify-between p-2 items-center">
                <div class='flex flex-row text-sm text-gray-400 w-fit'>Visual comparison test:</div>
                <nt-icon
                  class="{{run.assertion.assertions.image_comparison_pass ? 'text-green-500' : 'text-red-500'}}"
                  name="{{run.assertion.assertions.image_comparison_pass ? 'success' : 'cross'}}"></nt-icon>
              </div>
            </div>
          </div>

          <nt-icon *ngIf="run.session.info?.backend_type == 'mock'" name='frontend_isolated'
                   class='w-5 h-5 text-bop'
                   title='Frontend isolated'></nt-icon>

          <nt-icon *ngIf='run.session.info?.session_logged' name='user' class='w-5 h-5 text-bop'
                   title='Logged Session'></nt-icon>

          <div *ngIf='run.session === sessionOnHover' class='bo-button-icon w-8 h-8'
               (click)='showVideo(run.session.reference)'>
            <nt-icon name='play'></nt-icon>
          </div>
        </div>
        <div class='flex gap-2 overflow-auto scrollbar-sm'>
          <div *ngFor='let image of run.screenshot'>
            <nt-screenshot
              class='transition-all duration-50 w-64 h-28 rounded-md shadow-lg overflow-hidden border-nt-400 m-2 cursor-pointer'
              [class.border-2]='screenshotOnHover === image'
              (click)='goToVideo(run.session.reference,image.start!,run.video.start!)'
              (mouseover)='showImage(image)'
              (mouseout)='hideImage()'
              [reference]='image.reference' [name]='image.name'
              [lazyload]='true'></nt-screenshot>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<nt-session-preview-placeholder *ngIf='fullLoading'></nt-session-preview-placeholder>

<nt-popup *ngIf='showAssertionPopup' (close)='showAssertionPopup = false'>
  <div class='p-5 w-fit h-fit'>
    <h4 class='text-xl'>Test Results</h4>
    <label class='mt-4'>Original Fetch Unmatched</label>
    <div *ngFor="let httpResp of runSelected?.assertion?.assertions_details?.fetch_response_match_not_found">
      Method: {{httpResp.request.method}} Path: {{httpResp.request.path.split('api')[1]}}
    </div>
    <label class='mt-4'>Fetch Response Status</label>
    <div *ngIf="runSelected!.assertion!.assertions.fetch_response_pass"> All responses of the
      2 sessions are matched with the same STATUS CODE
    </div>
    <div *ngIf="!runSelected!.assertion!.assertions.fetch_response_pass"> Original Responses
      Unmatched: {{runSelected?.assertion?.assertions_details?.fetch_response_match_not_found?.length}}
      <div> Responses Error: {{runSelected?.assertion?.assertions_details?.fetch_response_compare_error?.length}}
        <div *ngFor="let httpResp of runSelected?.assertion?.assertions_details?.fetch_response_compare_error">
          <div>
            [Original] Method: {{httpResp.originalEvent.request.method}} Url: {{httpResp.originalEvent.request.url}}
            Status: {{httpResp.originalEvent.status}}
          </div>
          <div>
            [New] Method: {{httpResp.newEvent.request.method}} Url: {{httpResp.newEvent.request.url}}
            Status: {{httpResp.newEvent.status}}
          </div>
        </div>
      </div>
    </div>

    <label class='mt-4'>Fetch Request Body Type</label>
    <div *ngIf="runSelected!.assertion!.assertions.fetch_body_type_pass"> All Body Responses of the
      2 sessions are matched with the same TYPE
    </div>
    <div *ngIf="!runSelected!.assertion!.assertions.fetch_body_type_pass"> Original Responses
      Unmatched: {{runSelected?.assertion?.assertions_details?.fetch_body_type_match_not_found!.length}}
      <div> Responses Error: {{runSelected?.assertion?.assertions_details?.fetch_body_type_compare_error?.length}}
        <div *ngFor="let httpResp of runSelected?.assertion?.assertions_details?.fetch_body_type_compare_error">
          <div>
            [Original] Method: {{httpResp.originalEvent.request.method}} Url: {{httpResp.originalEvent.request.url}}
            Body Type: {{httpResp.originalEvent.response.headers['Content-type']}}
          </div>
          <div>
            [New] Method: {{httpResp.newEvent.request.method}} Url: {{httpResp.newEvent.request.url}}  Body
            Type: {{httpResp.newEvent.response.headers['content-type']}}
          </div>
        </div>
      </div>
    </div>

    <label class='mt-4'>Fetch Request Body Keys</label>
    <div *ngIf="runSelected!.assertion!.assertions.response_body_match_pass"> All Body Requests
      of the
      2 sessions are matched with the same KEYS
    </div>
    <div *ngIf="!runSelected!.assertion!.assertions.response_body_match_pass"> Original Responses
      Unmatched: {{runSelected?.assertion?.assertions_details?.request_body_match_not_found!.length}}
      <div> Responses Error: {{runSelected?.assertion?.assertions_details?.request_body_compare_error?.length}}
        <div *ngFor="let httpResp of runSelected?.assertion?.assertions_details?.request_body_compare_error">
          <div>
            [Original] Method: {{httpResp.originalEvent.request.method}} Url: {{httpResp.originalEvent.request.url}}
            Request Body: {{httpResp.originalEvent.request.body}}
          </div>
          <div>
            [New] Method: {{httpResp.newEvent.request.method}} Url: {{httpResp.newEvent.request.url}}  Request Body: {{httpResp.newEvent.request.body}}
          </div>
        </div>
      </div>
    </div>
  </div>
</nt-popup>

<nt-popup *ngIf='showSessionSettings' (close)='showSessionSettings = false'>
  <div class='p-5 w-fit h-fit'>
    <h4 class='text-xl'>Session Settings</h4>
    <label class='mt-4'>Set this session as User Login Session</label>
    <div class='w-fit mt-2'>
      <nt-switch [switched]='session.info.isLogin' (switchedChange)='setIsLoginSessionState($event)'>
      </nt-switch>
    </div>
    <h4 class='text-xl mt-5'>Rerun Settings</h4>
    <div class='flex items-end gap-3 mb-2'>
      <label class='mt-4'>Apply User Login Session</label>
      <nt-icon
        name='user'
        class='w-5 h-5'
        title='Logged Session'
        [class.text-bop]='loginSessionSelected'
        [class.text-gray-300]='!loginSessionSelected'>
      </nt-icon>
    </div>
    <sm-autocomplete
      *ngIf='!loginSessionSelected'
      [items]='loginSessions'
      [property]="'title'"
      (itemSelected)='setLoginReference($event); setIsLoginSessionState(false)'
      placeholder='Select Login Session'>
    </sm-autocomplete>
    <div class='w-fit h-10 flex items-center' *ngIf='loginSessionSelected'>
      <nt-badge (click)='setLoginReference(undefined)'>
        {{loginSessionSelected.title}}
      </nt-badge>
    </div>

    <div class='flex items-end gap-3'>
      <label class='mt-4'>Test Frontend in isolated mode</label>
      <nt-icon name='frontend_isolated' class='w-5 h-5'
               [class.text-bop]='backendType == "mock"'
               [class.text-gray-300]='backendType == "full"'
               title='Frontend isolated'></nt-icon>
    </div>
    <nt-switch class='mt-2' [switched]="backendType == 'mock'" (switchedChange)='toggleBackendType()'></nt-switch>

    <label class='mt-4'>Set Custom Domain Settings</label>
    <div class='flex flex-row items-center gap-2 mt-2'>
      <input [(ngModel)]='sessionDomain.domain' [placeholder]='"domain"'/> :
      <input class='w-14' [(ngModel)]='sessionDomain.port' [placeholder]='"port"'/>
      <nt-switch
        [switched]='sessionDomain.ssl'
        (switchedChange)='sessionDomain.ssl = !sessionDomain.ssl'>SSL
      </nt-switch>
    </div>
  </div>
</nt-popup>


